; MAD ASM
; nasm mad.asm -fbin -o mad.com

    org 100h 
 
section .text

    ; Push active display page (bh), current video mode (al), and number of character columns (ah) onto the stack
    mov ah, 0fh
    int 10h
    push bx
    push ax

    ; Change to medium resolution CGA mode (320x200 pixels, 4 colors)
    mov ax, 0004h
    int 10h

    ; Set background color to gray
    mov ah, 0bh
    mov bx, 0007h
    int 10h

    ; Select green-red-brown palette
    mov ah, 0bh
    mov bx, 0100h
    int 10h

    ; Draw line segments
    mov ax, ds
    mov es, ax    
    mov si, endpoints
    cld
    drawLines:
        mov di, x0              ; x0,y0,x1,y1 = endpoints[si];
        movsd                   ; si += 4;

        mov ah, [x1]
        sub ah, [x0]
        mov [delX], ah          ; delX = x1 - x0;
        jns .delXPos            ; if (delX < 0) {
            mov ah, 0
            sub ah, [delX]
            mov [delX], ah      ; delX = -delX;
            
            ; TODO sx = -1 (self-modifying code) 

            jmp .delXEnd
        .delXPos:               ; } else {
            ; TODO sx = 1 (self-modifying code) 
        .delXEnd:               ; }

        mov ah, [y1]
        sub ah, [y0]
        mov [delY], ah          ; delY = y1 - y0;
        jns .delYPos            ; if (delY < 0) {
            ; TODO sy = -1 (self-modifying code)             
        .delYPos:               ; } else {
            mov ah, 0
            sub ah, [delY]
            mov [delY], ah      ; delY = -delY;
            
            ; TODO sy = 1 (self-modifying code) 

            jmp .delYEnd
        .delYEnd:               ; } 

        mov ah, [delX]
        add ah, [delY]
        mov [err], ah           ; err = delX + delY;

        ; .loop:                  ; while (true) {


        ;     jmp .loop           ; }

        dec word [lines]        ; if (--lines != 0) {
        jnz drawLines           ;     goto drawLines;
                                ; }


    ; Wait for a keypress
    waitForKey:
        mov ah, 01h
        int 16h
        jz waitForKey
    mov ah, 00h
    int 16h    

    ; Restore original video mode
    pop ax
    mov ah, 00h    
    int 10h

    ; Restore original active display page
    mov ah, 05h
    pop bx
    mov al, bh
    int 10h

    ; Exit
    mov ax, 4c00h
    int 21h
 
section .data

    lines   dw  522

    x0      db  0
    y0      db  0
    x1      db  0
    y1      db  0
    delX    db  0
    delY    db  0
    err     db  0
    err2    db  0

    endpoints:
        dd 0x8163865f, 0x8165885d, 0x80718067, 0x8860895f, 0x974d9851, 0x8b43974f, 0x6e7f6e75, 0x725c775c, 0x974e8c43
        dd 0x83438c44, 0x6f7f6f75, 0x6e5d765d, 0x85448a43, 0x8cb195af, 0x6d66727a, 0x4f814b85, 0xab49a23f, 0x973d923d
        dd 0x91399236, 0xa24ba24d, 0xb2aaafaa, 0xb359ab53, 0xb760b359, 0xb2a7c58a, 0x868d8786, 0x869c8390, 0x868b8886
        dd 0x838b8497, 0x8e628a63, 0x8a658d60, 0x8e658d61, 0x8b668d63, 0x714b7944, 0x8ab386ad, 0x72876d87, 0x73786e74
        dd 0x9c7a9c79, 0x9f789f78, 0x9b799b79, 0x98779877, 0xa4519b50, 0xa23e9435, 0x9e439843, 0x933b9c3e, 0xa2509d51
        dd 0x91378e42, 0x9343943b, 0xa1489445, 0x8e4d934d, 0x89b395b0, 0x6d68747b, 0x51844b89, 0xaaa4a19f, 0xa06ca55c
        dd 0xab8bae72, 0xaa9ca19e, 0xc290c47a, 0xc585c57b, 0xc38dc485, 0xb4a9c389, 0xb185ab7d, 0xa5679f6d, 0xa8a59d93
        dd 0xab86b078, 0xa6adaeaf, 0xadada8ae, 0xb0aba9ad, 0xa9abaaab, 0x93959491, 0x8f9b8d9b, 0x8d968e8d, 0xac97ad89
        dd 0xb97bb071, 0xac90ac79, 0xb092b984, 0x964e8e4e, 0x8fb389b4, 0x6d656e65, 0x51814d89, 0x9750924f, 0x8ebb95b1
        dd 0x76626d63, 0x4b815283, 0xac50a542, 0x9f449547, 0x90388d3f, 0x923f9749, 0x82538e4f, 0x88bb8dbb, 0x6d607661
        dd 0x538a5280, 0x81688465, 0x81698466, 0x84728166, 0x836c8368, 0x973b953b, 0xa053a453, 0xa3439a38, 0xa3549f50
        dd 0x99789779, 0x99779778, 0x99859786, 0x9a869886, 0x9f8aa086, 0xa27da171, 0x9e7d9c78, 0xa2759e6f, 0x8c6b8d67
        dd 0x8c6d8d6e, 0x8d6c8d6b, 0x8c6e8c67, 0x81558c50, 0x87b989bc, 0x6e637362, 0x548d5380, 0x7c548154, 0x84af89b0
        dd 0x70627363, 0x53965490, 0x56595960, 0x5b5c5659, 0x575b5b5c, 0x59505b5c, 0x7c558055, 0x87b088af, 0x6d5f7460
        dd 0x558c5498, 0xa03c9836, 0x9f4d9e47, 0xa549a244, 0x9e389336, 0x8fc193c7, 0x9bc892c7, 0x93c898c8, 0x9cc698c7
        dd 0xb985b093, 0xad93ab86, 0xb181ab89, 0xab69a45d, 0xb97aaf6e, 0xae8aae79, 0xaa5da65f, 0xb689b979, 0x694d6d48
        dd 0x6c496249, 0x704d694d, 0x7b42704b, 0x8b958e91, 0x8e958b90, 0x8b898d87, 0x8b8c8c89, 0xa0ada5ae, 0x9bafa3ae
        dd 0xa2af9cb0, 0x9fae9dae, 0xa5b3a3b1, 0x9bb5a5b4, 0xa4b59fb6, 0xa4b3a1b1, 0x74b786b9, 0x84af89b0, 0x57915691
        dd 0x57965793, 0xa0459744, 0x96359b36, 0xac4b9e3d, 0x9e4d9d48, 0xc278bc6e, 0xb4a5bf90, 0xba97bc95, 0xbc9bc190
        dd 0xa6a5a4a4, 0xa684a583, 0xa563a665, 0xaf74af74, 0xa8a2a3a3, 0xab98ad90, 0xa961a95f, 0xaa5faa60, 0x8a728573
        dd 0x8a738674, 0x88758873, 0x87758672, 0xa7a2a198, 0xab7bab77, 0xaa66a85f, 0xb878b271, 0x86ba75b9, 0x80b085ae
        dd 0x58995895, 0x599b5996, 0x73b57ebc, 0x86ad80af, 0x6ab3589b, 0x5a9f6ab5, 0x9fb6a3b6, 0xa2b3a1b3, 0x9cbd99b6
        dd 0x9bbd99b7, 0x96c39bc3, 0x90ba94b4, 0x838a8887, 0x8789838b, 0x828d849b, 0x859c848c, 0x93bf94c3, 0x93c294bd
        dd 0x95c19bc2, 0x98c296c2, 0x95c393bd, 0x8c60886f, 0x8d738b71, 0x8d72896d, 0x896b8966, 0x8c988f95, 0x8e928b8d
        dd 0x8e8b8f89, 0x9296928f, 0x906f9165, 0x9266916c, 0x92689066, 0x90699067, 0x7eba77b7, 0x79ab7fb0, 0x6bb06bb6
        dd 0x72b76bb0, 0x7db077ab, 0x7f458444, 0x72b570b3, 0x7080707d, 0x84457f47, 0x7c447e45, 0x73897081, 0x728a7084
        dd 0x97b99bb6, 0x9ebaa1ba, 0x94bca0bb, 0x99bda0bc, 0x983b923c, 0x9c379337, 0x9848923e, 0xa54aa348, 0xa1499d4a
        dd 0xa04da04a, 0xa14da14a, 0xac4da945, 0x8d8b8b98, 0x94968c99, 0x8e999397, 0x9495928b, 0x59555a4e, 0x5b515b4e
        dd 0x5c4d5c51, 0x5d495b4d, 0xa0719f7b, 0x9e879e87, 0x9f75a07b, 0xa17aa175, 0x8b8a8d89, 0xb55ca855, 0xb055a954
        dd 0xb460ab51, 0xb55bab55, 0xb661af56, 0xb761b259, 0xbf6eac56, 0xb865ae54, 0x76487e44, 0x6c84728b, 0x71866c83
        dd 0x6d867086, 0x90bd91b7, 0x8fc290b9, 0x90b990c1, 0x91c68fc2, 0xb7a5bb9c, 0xb4a8b6a3, 0xafa9b6a7, 0xacaab3a9
        dd 0xaeb19bc8, 0xa4bcaeb3, 0xa9b5a4bb, 0xa4c0a0c5, 0x64495d50, 0x66485d51, 0x70476348, 0x604d6f48, 0x9a869887
        dd 0x9e8f9e8f, 0x9e89a084, 0xa0899f85, 0xad75ac6c, 0xac8ab08a, 0xa2a2a097, 0xa462a26b, 0xa7a59f98, 0xb885b97d
        dd 0xb092b58a, 0xa965a760, 0x6f4b7a42, 0x6e916d87, 0x7393708f, 0x779f7197, 0x7944704d, 0x6f966e89, 0x6f8b7096
        dd 0x769f7299, 0xb665b362, 0xc57ab563, 0xbe6db363, 0xc375b466, 0xc071c477, 0xc27abf71, 0xbf6fb566, 0xc589c273
        dd 0x9e909b8d, 0xa08d9b8f, 0xa08f9d90, 0x9f90a08c, 0x8373816b, 0x8173846f, 0x81728273, 0x816d8171, 0xa2989e93
        dd 0xb390b987, 0xab6bae90, 0xaa84a684, 0x89718772, 0x8a748871, 0x8b6d8b67, 0x8b6d8b6b, 0x93719172, 0x92719174
        dd 0x93728f74, 0x92748f75, 0x75577d56, 0x74a2749d, 0x75a373a3, 0x72a973a4, 0x7c577857, 0x73aa73a7, 0x79aa74aa
        dd 0x74a977a9, 0x705a7559, 0x775c705b, 0x527b4b83, 0x4b815279, 0xb978b679, 0xaa98af8d, 0xb07db17d, 0xb983b77a
        dd 0xac4eaa4a, 0x993c933e, 0xab53a654, 0x9b44a047, 0xa949ab4f, 0xa755aa51, 0xa3429f39, 0xa8459e39, 0xa5a5a59c
        dd 0xb87bb87b, 0x8d438e3e, 0xc38ac379, 0x918b918b, 0x91969196, 0x8b8f8b8f, 0x8f8b8e8a, 0xa466a561, 0xb184b081
        dd 0xa9a4a3a2, 0xab99a69e, 0x81958586, 0x82988190, 0x86868399, 0x9f6ea180, 0x9b72a06f, 0x9c719e6e, 0xaeb0a0c1
        dd 0x9cc8abb6, 0xababacb0, 0x93739073, 0x8265895d, 0x5860507b, 0x52795860, 0x57675474, 0x56605960, 0xb780b578
        dd 0xa566a662, 0xa983a883, 0xb084af84, 0x3cd532d5, 0x2dd331d4, 0x41d33dd4, 0x46cd42d2, 0x28cd2dd3, 0x25c528cc
        dd 0x4bc146cc, 0x4ab34ac2, 0x4bc14bb7, 0x25b625c5, 0x26b627b1, 0x47ae49b4, 0x48ae49b1, 0x26af26b0, 0x25a725ae
        dd 0x4ba748ad, 0x41a92ca9, 0x41a82ca8, 0x43a542a8, 0x2ca52ba8, 0x28a326a5, 0x2ba428a4, 0x2ca329a3, 0x44a244a4
        dd 0x4a9b4aa7, 0x4b9d4ba5, 0x4999499c, 0x2d9344a1, 0x2c972c95, 0x27972b97, 0x4b954898, 0x4b934996, 0x4b904b92
        dd 0x4a904a93, 0x258c2696, 0x468d4b8f, 0x468c4b8d, 0x4291458c, 0x40904191, 0x407e4090, 0x417d4190, 0x2887268b
        dd 0x25802786, 0x2679257f, 0x2b782778, 0x2c772877, 0x2c7b2c79, 0x436f2d7d, 0x2d7b436e, 0x427a407d, 0x457e437a
        dd 0x4480447f, 0x49804580, 0x4b7e497f, 0x4b774b7d, 0x4a784a7d, 0x48744b78, 0x49734b77, 0x4a6b4a72, 0x4b6c4b71
        dd 0x48664b6b, 0x49654b69, 0x446c446d, 0x2d65436b, 0x2c682c66, 0x27682b68, 0x4a5b4a63, 0x4b5b4b62, 0x445a4b5a
        dd 0x4a594559, 0x445d445b, 0x25612667, 0x285c2660, 0x3559445d, 0x345a445d, 0x2557285d, 0x25532556, 0x4a4e3559
        dd 0x274f2651, 0x2a4f284f, 0x2c4e284e, 0x2d532b4f, 0x3a4e2d53, 0x2d513a4d, 0x2d453b4b, 0x2c492c47, 0x27492b49
        dd 0x25422648, 0x4a474a4d, 0x4b454b4d, 0x353c4b45, 0x343c4a45, 0x4337343c, 0x273e2641, 0x2638283d, 0x25322537
        dd 0x45394438, 0x443d453b, 0x493d453d, 0x4b3b493c, 0x4a364a3b, 0x4b374b39, 0x48324b36, 0x49314b35, 0x272f2631
        dd 0x2c2f282f, 0x2c2d282d, 0x2c322c30, 0x432d2d33, 0x2d32442c, 0x4a294a30, 0x4b274b2d, 0x4427442c, 0x4b274427
        dd 0x45264a26, 0x3ac834c8, 0x3cc732c7, 0x33c632c6, 0x3fc53ac7, 0x43c03ec6, 0x2dc131c6, 0x2bc030c6, 0x2bb92bc0
        dd 0x2cc12cb6, 0x43b943c0, 0x42b642b7, 0x2db62db7, 0x41b52db5, 0x398c2f87, 0x2f86398b, 0x3980398a, 0x3086397f